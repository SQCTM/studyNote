# HTTP的代理

[TOC]

## 代理服务

指服务本身不生产内容，而是**处于中间位置转发上下游的请求和响应**，具有**双重身份**：

- 面向下游的用户时表现为服务器，代表源服务器响应客户端的请求
- 面向上游的源服务器时，表现为客户端，代表客户端发送请求



### 代理的作用

- **负载均衡**

  是代理**最基本的一个功能**。因为在面向客户端时屏蔽了源服务器，客户端看到的只是代理服务器。目的是尽量把外部的流量合理地分散到多台源服务器，提高系统的整体资源利用率和性能

- **健康检查**

  使用“心跳”等机制监控后端服务器，发现有故障就及时“踢出”集群，保证服务高可用

- **安全防护**

  保护被代理的后端服务器，限制IP地址或流量，抵御网络攻击和过载

- **加密卸载**

  对外网使用SSL/TLS加密通信认证，而在安全的内网不加密，消除加解密成本

- **数据过滤**

  拦截上下行的数据，任意指定策略修改请求或者响应

- **内容缓存**

  暂存，复用服务器响应



### 代理相关头字段

- **Via**

  标明代理的身份，这是一个通用字段，请求头或响应头里都可以出现，每当报文经过一个代理节点，代理服务器就会把自身的信息追加到字段的末尾，如果通信链路中有很多中间代理就会在Via里形成一个链表，这样就可以知道报文究竟走过了多少个环节才到达了目的地

  *该字段只解决了客户端和源服务器判断是否存在代理的问题，不能知道对方的真实信息

- **X-Forwarded-For**

  与Via类似，每经过一个代理节点就会在字段里追加一个信息，但Via追加的是代理主机名或域名，而该字段追加的是请求方的IP地址，所以字段里最左边的IP地址就是客户端的地址

- **X-Real-IP**

  记录客户端IP地址，没有中间的代理信息，相当于是X-Forwarded-For的简化版，如果客户端和源服务器之间只有一个代理，那么这两个字段的值就是相同的



### 代理协议

通过X-Forwarded-For操作代理信息必须要解析HTTP报文头，这对于代理来说成本比较高，会降低代理的转发性能；且上述的头字段必须要修改原始报文，然而如果使用HTTPS通信被加密等情况这是不允许的，因此出现了一个专门的代理协议，有两个版本：

- **v1**

  和HTTP差不多，是明文，它在HTTP报文前增加了一行ASCII码文本，即以"PROXY"开头，后接 "TCP4" 或 "TCP6"表示客户端的IP地址类型，再后面是请求方地址、应答方地址、请求方端口号、应答方端口号，最后用一个回车换行 \r\n 结束

  例如：`PROXY TCP4 1.1.1.1 2.2.2.2 555555 80\r\n `

  这样服务器收到报文只用解析第一行就可以拿到客户端地址，不需要再去处理后面的HTTP数据

- **v2**

  是二进制格式

*代理协议不支持X-Forwarded-For的链式地址形式，所以拿到客户端地址后再如何处理就需要代理服务器与后端自行约定



## 缓存代理服务

支持缓存控制的代理服务，HTTP的服务器缓存功能主要由代理服务器来实现，即缓存代理

加入缓存后代理服务收到源服务器发来的响应数据后需要做两件事，第一个是把报文转发给客户端，第二个就是把报文存入自己的Cache。下次再有相同的请求，代理服务器就可以直接发送304或者缓存数据，不必再从源服务器那里获取，这样降低了客户端的等待时间，同时节约了源服务器的网络带宽

*缓存代理即不是客户端也不是服务器，它只是一个数据中转站，并不是真正的数据消费者和生产者



### 源服务器的缓存控制

- 约束客户端的Cache-Control同样可以约束代理，但客户端的缓存只是用户自己使用，而代理的缓存可能会为非常多的客户端提供服务，所以需要对它的缓存再多一些限制条件：

  - **private**

    表示缓存只能在客户端保存，是用户私有的，不能放在代理上与别人共享

  - **public**

    缓存完全开放，谁都可以存，谁都可以用

- 缓存失效后的重新验证也要区分：

  - **must-revalidate**

    只要过期就必须回源服务器严重

  - **proxy-revalidate**

    只要求代理的缓存过期后必须验证，客户端不必回源，只验证到代理这个环节就行了

- 缓存生成时间：

  - **s-maxage**

    只限定在代理上能够存多久

  - **no-transform**

    代理有时候会对缓存下来的数据做一些优化，此字段禁止这样做



### 客户端的缓存控制

- **max-stale**

  如果代理上的缓存过期了也可以接受，但不能过期太多，超过该字段值数秒就不会要了

- **min-fresh**

  缓存必须有效，而且必须在该字段值数秒后依然有效

- **only-if-cached**

  表示只接受代理缓存的数据，不接受源服务器的响应。如果代理上没有缓存或者缓存过期，就给客户端返回一个504