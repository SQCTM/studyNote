# HTTPS的优化

[TOC]

## 硬件优化

HTTPS连接是计算密集型，而不是I/O密集型，买网卡、宽带、SSD存储起不到优化效果，正确的优化策略是：

- 选择**更快的CPU**，最好内建AES优化，可以加速握手也可以加速传输
- 选择**SSL加速卡**，加解密时调用它的API，让专门的硬件来做非对称加解密，分担CPU的计算压力；缺点是升级慢、支持算法有限、不能灵活定制解决方案等
- **SSL加速服务器**，用专门的服务器集群来彻底卸载TLS握手时的加解密计算，性能自然要比单纯的加速卡强大很多。其中关键的一点是通信必须是异步的，不能阻塞应用服务器，否则加速没有意义



## 软件优化

- **软件升级**

  把现在正在使用的软件尽量升级到最新版本，但对于很多大中型公司来说进行硬件升级或软件升级需要大量人手且有较高风险，可能会影响正常的线上服务

- **协议优化**

  尽量采用TLS1.3，它大幅度简化了握手的过程且更加安全；如果只能用 1.2，那么握手时使用的密钥交换协议应当尽量选用椭圆曲线的 ECDHE 算法，它不仅运算速度快安全性高，还支持“False Start”，能够达到与 TLS1.3 类似的效果。另外，椭圆曲线也要选择高性能的曲线，最好是 x25519，次优选择是 P-256



## 证书优化

- **证书传输**

  服务器的证书可以选择椭圆曲线（ECDSA）证书而不是 RSA 证书，因为 224 位的 ECC 相当于 2048 位的 RSA，所以椭圆曲线证书的“个头”要比 RSA 小很多，即能够节约带宽也能减少客户端的运算量

- **证书验证**

  服务器使用OCSP（在线证书状态协议），向 CA 发送查询请求，让 CA 返回证书的有效状态，避免客户端访问 CA 去验证证书

  但 OCSP 要多出一次网络请求的消耗，而且还依赖于 CA 服务器，如果 CA 服务器很忙，响应延迟是等不起的，于是又出来了一个“补丁”，叫“OCSP Stapling”（OCSP 装订），它可以让服务器预先访问 CA 获取 OCSP 响应，然后在握手时随着证书一起发给客户端，免去了客户端连接 CA服务器查询的时间



## 会话复用

效果类似 Cache，前提是客户端必须之前成功建立连接，后面就可以用“Session ID”“Session Ticket”等凭据跳过密钥交换、证书验证等步骤，直接开始加密通信