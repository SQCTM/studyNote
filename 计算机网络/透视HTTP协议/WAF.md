# WAF

[TOC]

## Web服务器遇到的威胁

HTTPS仅仅保证了“通信链路安全”，让第三方无法得知传输的内容。但在通信链路的两端即客户端和服务器，它无法提供保护，黑客可以通过一些手段攻击Web服务器

- **DDoS攻击**

  又称**洪水攻击**，黑客会控制许多“僵尸”计算机，向目标服务器发起大量无效请求。因为服务器无法区分正常用户和黑客，只能“照单全收”，这样就挤占了正常用户所应有的资源。如果黑客的攻击强度很大，就会像“洪水”一样对网站的服务能力造成冲击，耗尽带宽、CPU 和内存，导致网站完全无法提供正常服务。这种攻击方式简单粗暴，虽然有效但不涉及HTTP协议内部的细节，技术含量低

- **SQL注入**

  一种**代码注入**攻击，它利用了服务器字符串拼接形成SQL语句的漏洞，构造出非正常的SQL语句，获取数据库内部的敏感信息

- **HTTP头注入**

  也是一种**代码注入**攻击，，它在“Host”“User-Agent”“X-Forwarded-For”等字段里加入了恶意数据或代码，服务端程序如果解析不当，就会执行预设的恶意代码

- **跨站脚本攻击**

  即XSS攻击，属于JS代码注入攻击，利用JS脚本获取未设防的Cookie



## 网络应用防火墙

防御黑客攻击Web服务器手段要用到网络应用防火墙，即**WAF**

- **WAF**

  工作在七层，能看到整个HTTP报文，是一种“**HTTP入侵检测和防御系统**“，能够对报文内容做更深入细致的审核，使用更复杂的条件、规则来过滤数据

  - **功能**

    - IP黑名单和白名单，拒绝黑名单上地址的访问，或者只允许白名单上的用户访问
    - URI 黑名单和白名单，与IP黑白名单类似，允许或禁止对某些URI的访问
    - 防护DDoS攻击，对特定的IP地址限连限速
    - 过滤请求报文，防御“代码注入”攻击
    - 过滤响应报文，防御敏感信息外泄
    - 审计日志，记录所有检测到的入侵操作

  - **原理**

    拿到HTTP请求、响应报文，用字符串处理函数看有没有关键字、敏感词，或者用正则表达式做一下模式匹配，命中了规则就执行对应的动作，比如返回 403/404

  - **缺点**

    WAF 实质上是模式匹配与数据过滤，所以会消耗CPU，增加一些计算成本，降低服务能力，使用时需要在安全与性能之间找到一个平衡点

- **传统防火墙**

  传统“防火墙”工作在三层或四层，隔离了外网和内网，使用预设的规则，只允许某些特定IP地址和端口号的数据包通过，拒绝不符合条件的数据流入或流出内网，实质上是一种**网络数据过滤设备**



## WAF解决方案

**ModSecurity**，是一个开源的、生产级的 WAF 工具包，可以说是WAF界事实上的标准

核心组成部分是“规则引擎”和“规则集”，两者的关系有点像杀毒引擎和病毒特征库



## 木桶效应

又称短板效应，网站的整体安全不在于你加固的最强的那个方向，而是在于你可能都没有意识到的“短板”。黑客往往会“避重就轻”，只要发现了网站的一个弱点，就可以“一点突破”，其他方面的安全措施也就都成了“无用功”。

所以使用 WAF 最好“不要重新发明轮子”，而是使用现有的、比较成熟的、经过实际考验的 WAF 产品