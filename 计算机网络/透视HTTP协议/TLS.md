# TLS

[TOC]

## HTTPS建立连接

HTTPS协议会先与服务器执行TCP握手，然后执行TLS握手才能建立安全连接



## TLS协议的组成

TLS 包含几个子协议，即几个不同职责的模块，比较常用的有：

- **记录协议**

  规定了TLS收发数据的基本单位：记录（record）。所有的其他子协议都需要通过记录协议发出。但多个记录数据可以在一个TCP包里一次性发出，不需要像TCP那样返回ACK

- **警报协议**

  向对方发出警报信息。比如protocol_version是不支持旧版本，bad_certificate是证书有问题，收到警报后另一方可以选择继续，也可以立即终止连接

- **握手协议**

  是 TLS 里最复杂的子协议，浏览器和服务器会在握手过程中协商TLS版本号、随机数、密码套件等信息，然

  后交换证书和密钥参数，最终双方协商得到会话密钥，用于后续的混合加密系统

- **变更密码规范协议**

  它非常简单，就是一个“通知”，告诉对方后续的数据都将使用加密保护。反过来，在它之前，数据都是明文的



## TLS握手

多个记录组合成一个 TCP 包发送，最多经过两次消息往返（4 个消息）就可以完成握手，然后就可以在安全的通信环境里发送 HTTP 报文，实现 HTTPS 协议

握手的目标是安全地交换对称密钥，需要三个随机数，第三个随机数“Pre-Master”必须加密传输，绝对不能让黑客破解



## TLS1.3

- 为了兼容1.1、1.2等“老”协议，TLS1.3 会“伪装”成TLS1.2，新特性在“扩展”里实现
- 1.1、1.2 在实践中发现了很多安全隐患，所以TLS1.3大幅度删减了加密算法，只保留了ECDHE、AES、ChaCha20、SHA-2 等极少数算法，强化了安全
- TLS1.3简化了握手过程，完全握手只需要一个消息往返，提升了性能