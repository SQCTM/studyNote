# HTTP性能优化

[TOC]

## HTTP服务器

- **性能指标**

  衡量服务器性能的主要指标有三个：**吞吐量**、**并发数**和**响应时间**

  - **吞吐量**

    即RPS，**每秒的请求次数**，它是服务器最基本的性能指标，RPS越高就说明服务器的性能越好

  - **并发数**

    反映的是服务器的负载能力，服务器能够同时支持的客户端数量，越多越好，能够服务更多的用户

  - **响应时间**

    反映的是服务器的处理能力，即快慢程度，响应时间越短，单位时间内服务器就能够给越多的用户提供服务，提高吞吐量和并发数

  - **资源利用率**

    除了上面的三个基本性能指标，服务器还要考虑CPU、内存、硬盘和网卡等系统资源的占用程度，利用率过高或者过低都可能有问题

- **优化方向**
  - 合理利用系统资源
  - 提高服务器的吞吐量和并发数
  - 降低响应时间



## HTTP客户端

最基本的性能指标就是**延迟**

- **影响延迟的因素**

  - **光速**，地理距离而导致的延迟是无法克服的

  - **带宽**，它包括接入互联网时的电缆、WiFi、4G和运营商内部网络、运营商之间网络的各种带宽，每一处都有可能成为数据传输的瓶颈，降低传输速度，增加延迟

  - **DNS 查询**，如果域名在本地没有缓存，就必须向DNS系统发起查询，引发一连串的网络通信成本，而在获取IP地址之前客户端只能等待，无法访问网站

  - **TCP 握手**，必须要经过 SYN、SYN/ACK、ACK三个包之后才能建立连接，它带来的延迟由光速和带宽共同决定

    建立 TCP 连接之后，就是正常的数据收发了，后面还有解析 HTML、执行 JavaScript、排

    版渲染等等，这些也会耗费一些时间。但不属于HTTP范围了



## HTTP传输链路

客户端和服务器之间的传输链路是影响HTTP性能的关键

- **互联网的划分**

  - **第一公里**

    是**网站的出口**，即**服务器接入互联网的传输线路**，它的带宽直接决定了网站对外的服务能力，即吞吐量等指标，应尽量购买大带宽，接入更多的运营商网络

  - **中间一公里**

    是**许多小网络组成的实际的互联网**，是非常庞大和复杂的网络，地理距离、网络互通都严重影响了传输速度，在这CDN起到了非常大的作用

  - **最后一公里**

    是**用户访问互联网的入口**，对于固网用户就是光纤、网线，对于移动用户就是 WiFi、基站。以前它是客户端性能的主要瓶颈，延迟大带宽小，但随着近几年4G和高速宽带的普及，这里的情况已经好了很多，不再是制约性能的主要因素了

- **网站内部Web服务系统**

  网站内部的Web服务系统也是一个小型的网络，中间的数据处理、传输会导致延迟，增加服务器的响应时间，这也是一个不可忽视需要优化的点



## 软件优化

有三个关键点：**开源**、**节流**和**缓存**，将三点搭配起来**应用于传输链路**，能让HTTP性能再上一个台阶



### 开源

开发网站服务器自身的潜力，在现有条件不变的情况下尽量挖掘出更多的服务能力

- **选用高性能的Web服务器**

  最佳选择是Nginx/OpenResty ，尽量不要选择基于Java、Python、Ruby 的其他服务器，它们用来做后面的业务逻辑服务器更好

- **对于HTTP协议一定要启用长连接**

  长连接虽然不能优化连接握手，但可以把成本“均摊”到多次请求里，这样只有第一次请求会有延迟，之后的请求就不会有连接延迟，总体的延迟也就降低了

- **使用TCP 的新特性“TCP Fast Open”**

  效果类似 TLS 的“False Start”，可以在初次握手的时候就传输数据，也就是0-RTT，所以我们应该尽可能在操作系统和 Nginx 里开启这个特性，减少外网和内网里的握手延迟



### 节流

减少客户端和服务器之间收发的数据量，在有限的带宽里传输更多的内容

- **最基本做法**

  使用 HTTP 协议内置的“数据压缩”编码，不仅可以选择标准的gzip，还可以积极尝试新的压缩算法br，它有更好的压缩效果

- **选择适当压缩率**

  在数据压缩的时候应当注意选择适当的压缩率，不要追求最高压缩比，否则会耗费服务器的计算资源，增加响应时间，降低服务能力，反而会“得不偿失“

- **其他优化点**

  - **域名**

    应当适当**收缩域名**，限制在两三个左右，减少解析完整域名所需的时间，让客户端尽快从系统缓存里获取解析结果

  - **重定向**

    重定向引发的客户端延迟也很高，它不仅增加了一次请求往返，还有可能导致新域名的DNS解析，是HTTP前端性能优化的“大忌”。除非必要，应当尽量不使用重定向，或者使用 Web 服务器的“内部重定向



### 缓存

- **在网站系统内部**

  可以使用Memcache、Redis、Varnish等专门的缓存服务，把计算的中间结果和资源存储在内存或者硬盘里，Web服务器首先检查缓存系统，如果有数据就立即返回给客户端，省去了访问后台服务的时间

- **在“中间一公里”**

  缓存更是性能优化的重要手段，CDN 的网络加速功能就是建立在缓存的基础之上的，如果没有缓存，那就没有CDN



## 使用HTTP/2

HTTP/2消除了应用层的队头阻塞，拥有头部压缩、二进制帧、多路复用、流量控制、服务器推送等许多新特性，大幅度提升了 HTTP 的传输效率

- **一些在HTTP/1里的优化手段在HTTP/2里会有反效果**
  - 对于HTTP/2来说，一个域名使用一个TCP连接才能够获得最佳性能，如果开多个域名，就会浪费带宽和服务器资源，也会降低HTTP/2的效率，所以**域名收缩**在HTTP/2里是必须要做的
  - 资源合并在HTTP/1里减少了多次请求的成本，但在 HTTP/2 里因为有头部压缩和多路复用，传输小文件的成本很低，**资源合并失去意义**。资源合并还有一个缺点，就是降低了缓存的可用性，只要一个小文件更新，整个缓存就完全失效，必须重新下载。所以在现在的大带宽和CDN应用场景下，应当尽量少用资源合并（JS、CSS 图片合并，数据内嵌），让资源的粒度尽可能地小，才能更好地发挥缓存的作用