# HTTP的Cookie机制

[TOC]

## Cookie

HTTP协议本身是无状态的，没有记忆能力，所以需要一个标志来对用户身份进行验证

Cookie是服务器委托浏览器存储的一些数据，让服务器有了记忆能力



## Cookie的工作过程

- **响应头字段Set-Cookie**

  - 当用户通过浏览器第一次访问服务器时，服务器不知道他的身份，于是创建一个独特的身份标识数据"**key=value**"放进Set-Cookie字段里，随着响应报文一同发给浏览器

  - 服务器有时会在响应头里添加多个Set-Cookie，存储多个"**key=value**"

- **请求头字段Cookie**

  - 浏览器收到响应报文后看到Set-Cookie字段就会保存起来，下次再请求时就自动把这个值放进Cookie字段里发送给服务器。服务器看到后知道该用户不是第一次访问，就可以拿出Cookie里的值识别出用户身份然后提供个性化服务

  - 浏览器发送多个身份标识数据不需要用多个Cookie字段，只要写在一行中用 “;” 隔开

*Cookie是由浏览器负责存储的，所以它是和浏览器绑定的，只能在本浏览器内生效，如果换个浏览器或换个设备就只能重新走Set-Cookie流程



## Cookie的属性

- **作用**

  保护身份标识数据，防止外泄或窃取

- **设置Cooike的生存周期**

  即有效期，过期Cookie失效，浏览器在存储里删除该Cookie，也不会发送给浏览器

  - **Expires**：过期时间，用的是绝对时间点，即**截止日期**
  - **Max-Age**：即**有效时间长度**，相对时间，单位是秒，浏览器收到报文的时间点后过多长时间Cookie失效
  - Expires和Max-Age**可以同时出现**，若两者最后失效时间不一致浏览器会**优先采用Max-Age计算的失效期**

- **设置Cookie的作用域**

  让浏览器仅发送给特定的服务器和URI，避免被其他网站盗用

  - **Domain**：指定了Cookie所属的域名
  - **Path**：指定了Cookie所属的路径
  - 浏览器在发送Cookie前会从URI中提取出host和path部分，对比这两个Cookie属性，如果不满足条件就不会在请求头里发送Cookie

- **Cookie的安全性**

  用document.cookie来读写数据有安全隐患，可能会导致跨站脚本XSS攻击窃取数据

  - **HttpOnly**

    告诉浏览器此Cookie只能通过浏览器HTTP协议传输，禁止其他方式访问，浏览器的JS引擎就会禁用document.cookie等一切相关的API，就不会发送脚本攻击

  - **SameSite**

    可以防范跨站请求伪造（XSRF）攻击

    - **SameSite=Strict**：可以严格限定Cookie不能随着跳转链接跨站发送
    - **SameSite=Lax**：允许GET/HEAD等安全方法，但禁止POST跨站发送

  - **Secure**

    表示这个Cookie仅能用HTTPS协议加密传输，明文的HTTP协议会禁止发送，但Cookie本身不是加密的，浏览器里还是以明文的形式存在



## Cookie的应用

- **身份识别**

  保护用户的登录信息，实现有状态的会话事物

- **广告跟踪**

  用户看到广告时被偷偷标记，这样上其他网站别的广告就能用Cookie读出你的身份再推给你广告

  这种Cookie不是由访问的主战存储的，所以又叫“第三方Cookie”，这样会导致广告泛滥

- 为防止滥用Cookie搜集用户隐私，互联网组织提出了DNT和P3P，但实际作用不大



