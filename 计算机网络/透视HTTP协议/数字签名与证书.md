# 数字签名与证书

[TOC]

加密实现了机密性，但仅有机密性还不够安全，还必须加上完整性、身份认证等特性才能实现真正的安全



## 摘要算法

- **实现完整性的手段**，即散列函数、哈希函数，它能够把任意长度的数据“压缩”成长度固定且独一无二的摘要字符串，它只有算法，加密后的数据无法解密，不能从摘要逆推出原文

- 摘要算法实际上是**把数据从一个“大空间”映射到了“小空间”**，所以就存在“冲突”（也叫碰撞）的可能性，**可能会有两份不同的原文对应相同的摘要**。好的摘要算法必须能够抵抗冲突，让这种可能性尽量地小

- 因为摘要算法对输入具有“单向性”和“雪崩效应”，输入的微小不同会导致输出的剧烈变化，所以也被 TLS 用来**生成伪随机数**
- 目前TLS推荐使用的摘要算法是**SHA-2**，它实际是一系列摘要算法的统称，总共有6种，常用的有 SHA224、SHA256、SHA384，分别能够生成 28 字节、32 字节、48 字节的摘要
- 摘要算法保证了“数字摘要”和原文是完全等价的，所以只要在原文后附上它的摘要，就能够保证数据的完整性
- 摘要算法**不具有机密性**，如果明文传输也可能被篡改，所以真正的完整性必须要建立在机密性之上，在混合加密系统里用会话密钥加密消息和摘要，这叫**哈希消息认证码**（HMAC）



## 数字签名

非对称加密里的**私钥加上摘要算法**，可以同时**实现“身份认证”和“不可否认“**

- **原理**

  私钥只加密原文的摘要，公钥解密

- **签名和验签**

  数字签名完全公开，签名只有用私钥对应的公钥才能解开，拿到摘要后再比对原文验证完整性，因为私钥是保密的，黑客不能伪造签名，就能够保证通信双方的身份以及消息的真实性



## 数字证书和CA

- 为了防止黑客伪造公钥，应该找一个公认的可信第三方**CA**（Certificate Authority，证书认证机构）

- **CA 对公钥的签名认证的格式**

  要包含序列号、用途、颁发者、有效时间等等，把这些打成一个包再签名，完整地证明公钥关联的各种信息，形成“数字证书”

- 签发的证书种类

  签发的证书分 DV、OV、EV 三种，区别在于可信程度。DV 是最低的，只是域名级别的可信，不知道背后是谁；EV 是最高的，经过了法律和审计的严格核查，可以证明网站拥有者的身份

- **CA信任链**

  公钥的分发需要使用数字证书，必须由 CA 的信任链来验证，否则就是不可信的。小一点的 CA 让大 CA 签名认证，但链条的最后，也就是Root CA只能自己证明自己了，这个就叫“**自签名证书**”或者“**根证书**”



## 证书体系的弱点

- **弱点**
  - 如果 CA 失误或者被欺骗，签发了错误的证书，虽然证书是真的，可它代表的网站却是假的
  - 如果CA 被黑客攻陷，或者 CA 有恶意，因为它（即根证书）是信任的源头，整个信任链里的所有证书也就都不可信了
- **补丁**
  - 针对第一种，开发出了 CRL（证书吊销列表）和 OCSP（在线证书状态协议），**及时废止有问题的证书**
  - 针对第二种，因为涉及的证书太多，就只能操作系统或者浏览器从根上下手了，撤销对 CA 的信任，列入“黑名单”，这样它颁发的所有证书就都会被认为是不安全的