# CDN加速网络服务

[TOC]

## 为什么需要网络加速

- **地理距离**

  地理距离过远没有本地连接快

- **运营商网络**

  互联网从逻辑上看是一张大网，但实际上是由许多小网络组成的，这其中有小网络“互连互通”的问题，典型的就是各个电信运营商的网络

  这些小网络内部的沟通很顺畅，但网络之间却只有很少的联通点，跨网传输需要和其他许多用户挤连接点，宽带是有限的，能抢到多少看运气

- **路由转发**

  网络中存在许多的路由器、网关，数据每经过一个节点，都要停顿一下，在二层、三层解析转发，这会消耗一定的时间，带来延迟



## 什么是CDN

是专门为解决“长距离”上网络访问速度慢而诞生的一种网络应用服务，有三个**关键点**：

- **网络**

  CDN的最核心原则是“**就近访问**”，如果用户能够在本地几十公里的距离之内获取到数据，那么时延就基本上变成0。所以CDN投入了大笔资金，在全球的各个大枢纽城市都建立了机房，部署了大量拥有高存储高带宽的节点，构建了一个专用网络。这个网络是跨运营商、跨地域的，虽然内部也划分成多个小网络，但它们之间用高速专有线路连接，是真正的“信息高速公路”，基本上可以认为不存在网络拥堵

- **分发**

  运用**缓存代理**技术，使用“推”或“拉”的手段，把源站的内容逐级缓存到网络的每一个节点上。用户在上网的时候就不直接访问源站，而是访问离他最近的一个CDN节点，术语叫“**边缘节点**”，节点缓存了源站内容的代理服务器，这样就省去了长途跋涉的时间成本，实现了网络加速

- **内容**

  CDN加速分发的内容即HTTP协议里的资源，比如超文本、图片、音频等。资源按照是否可缓存分为**静态资源**和**动态资源**

  - **静态资源**：数据内容静态不变，比如图片、音频
  - **动态资源**：数据内容是动态变化的，由后台服务计算生成

  只有静态资源才能被缓存加速、就近访问，动态资源只能由源站实时生成。但如果动态资源指定了**Cache-Control**，允许缓存短暂的时间，在这段时间内它就变成了静态资源，可以被CDN缓存加速



## CDN的运行

CDN的运行有两个关键点：**全局负载均衡**和**缓存系统**



### 全局负载均衡

简称GSLB，是CDN的大脑。主要的职责是当用户接入网络的时候在CDN专网中挑选出一个最佳节点提供服务，解决的是用户如何找到最近的边缘节点，对整个CDN网络进行负载均衡

- **DNS负载均衡**

  是GSLB最常见的实现方式，智能调度边缘节点提供服务

  - **过程**

    权威DNS返回的不是IP地址，是一个**CNAME别名记录**，指向的是CDN的GSLB。因为没拿到IP地址，于是本地DNS就会向GSLB再发起请求，这样就进入了CDN的全局负载均衡系统，开始智能调度

  - **智能调度依据**

    - 看用户的IP地址，查表得知地理位置，找相对最近的边缘节点
    - 看用户所在的运营商网络，找相同网络的边缘节点
    - 检查边缘节点的负载情况，找负载较轻的节点
    - 其他，比如节点的“健康状况”、服务能力、带宽、响应时间等

    GSLB把这些因素综合起来，用一个复杂的算法，最后找出一台最合适的边缘节点，把这个节点的 IP地址返回给用户，用户就可以就近访问CDN的缓存代理了



### 缓存系统

是CDN的心脏，使用HTTP缓存代理技术，有两个关键点：**命中**和**回源**，缓存命中就返回给用户，否

则就要回源

- **命中**

  指用户访问的资源恰好在缓存系统里，可以直接返回给用户

  - **命中率**：衡量 CDN 服务质量的指标，命中次数与所有访问次数之比，**命中率越高越好**

- **回源**

  指用户访问的资源缓存里没有，必须用代理的方式回源站取

  - **回源率**：衡量 CDN 服务质量的指标，回源次数与所有访问次数之比，**回源率越低越好**

- **提高命中率、降低回源率**

  - 最基本的方式是在**存储系统**上下功夫。硬件用高速CPU、大内存、万兆网卡，再搭配TB级别的硬盘和快速的SSD；软件方面不断“求新求变”，各种新的存储软件都拿来尝试，尽可能地高效利用存储，存下更多的内容
  - **缓存系统**可以**划分层次**，分成一级缓存节点和二级缓存节点。一级缓存配置高一些，直连源站；二级缓存配置低一些，直连用户。回源的时候二级缓存只找一级缓存，一级缓存没有才回源站，这样最终“扇入度”就缩小了，可以有效地减少真正的回源
  - 使用**高性能的缓存服务**

