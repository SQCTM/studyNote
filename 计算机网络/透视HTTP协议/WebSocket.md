# WebSocket

[TOC]

运行在Web即HTTP上的Socket通信规范，一种基于TCP的轻量级网络通信协议，在地位上与HTTP“平级”



## 为什么需要WebSocket

为了克服 HTTP“请求 - 应答”模式的缺点，WebSocket因此而产生

- **HTTP通信模式缺点**

  HTTP通信模式请求-应答是一种“**半双工**”的通信模式，虽然可以双向收发数据，但同一时刻只能一个方向上有动作，传输效率低。而且它是一种“被动”通信模式，服务器只能“被动”响应客户端的请求，无法主动向客户端发送数据

  虽然后来的HTTP/2、HTTP/3新增了Stream、Server Push等特性，但“请求 - 应答”依然是主要的工作方式。这就导致HTTP难以应用在动态页面、即时消息、网络游戏等要求“实时通信”的领域

- **轮询**

  在WebSocket出现之前，在浏览器环境里用JS开发实时Web应用很麻烦。因为浏览器是一个“受限的沙盒”，不能用TCP，只可用HTTP协议，所以出现了很多变通的技术，轮询是比较常用的一种

  轮询就是不停地向服务器发送HTTP请求，问有没有数据，有数据的话服务器就用响应报文回应。如果轮询的频率比较高，那么就可以近似地实现“实时通信”的效果

  - **缺点**

    反复发送无效查询请求耗费了大量的带宽和CPU资源，非常不经济



## WebSocket特点

是一个“**全双工**”的通信协议，运行在浏览器环境里。与TCP一样，客户端和服务器都可以随时向对方发送数据。服务器可以变得主动。一旦后台有新的数据，就可以立即推送给客户端，“实时通信”的效率就提高了

- **习惯上向HTTP靠拢**

  WebSocket 采用了二进制帧结构，语法、语义与HTTP完全不兼容，但因为它的主要运行环境是浏览器，为了便于推广和应用，在使用习惯上尽量向HTTP靠拢，这就是它名字里“Web”的含义

- **服务发现方面**

  WebSocket**延用了HTTP的URI格式**，但开头的协议名不是“http”，引入的是两个新的名字：“**ws**”和“**wss**”，分别表示明文和加密的WebSocket协议

- **默认端口号**

  选择了**80**和**443**，因为现在互联网上的防火墙屏蔽了绝大多数的端口，只对HTTP的 80、443 端口放行，所以WebSocket就可以“伪装”成HTTP协议，比较容易地穿透防火墙，与服务器建立连接

*要注意的一点是，虽然大多数情况下我们会在浏览器里调用API来使用WebSocket，但它不是一个“调用接口的集合”，而是一个**通信协议**



## 帧结构

长度不固定，最少2个字节，最多14个字节，开头2个字节是必须的，也是最关键的

 WebSocket的帧头有四个部分：**“结束标志位 + 操作码 + 帧长度 +掩码”**

1. **第一个字节**
   1. 第一位“FIN”是消息的**结束标志位**，表示数据发送完毕。一个消息可以拆成多个帧，接收方看到“FIN”后，把前面的帧拼起来，组成完整的消息
   2. “FIN”后面的三个位是**保留位**，目前没有任何意义，但必须是0
   3. 最后四位很重要，叫“**Opcode**”，**操作码**，就是**帧类型**，比如1表示帧内容是纯文本，2表示帧内容是二进制数据，8是关闭连接，9和10分别是连接保活的PING和PONG
2. **第二个字节**
   1. 第一位是**掩码标志位“MASK”**，表示帧内容是否使用异或操作做简单的加密。目前WebSocket标准规定，客户端发送数据必须使用掩码，而服务器发送必须不使用掩码
   2. 后7位是“**Payload len**”，**长度字段**，表示帧内容的长度。它是另一种变长编码，最少7位，最多是7+64位，也就是额外增加8个字节，所以一个WebSocket**帧最大是2^64**
   3. 长度字段后面是“**Masking-key**”，**掩码密钥**，它是由上面的标志位“MASK”决定的，如果使用掩码就是4个字节的随机数，否则就不存在



## WebSocket的握手

WebSocket的握手是一个标准的HTTP GET请求，但要带上两个协议升级的专用头字段：

```
"Connection: Upgrade"，表示要求协议“升级”；
"Upgrade: websocket"，表示要“升级”成WebSocket协议。
```

*在握手过程中有个非常简单的认证机制，目的是防止误连接，防止普通的HTTP消息被误识别成WebSocket

