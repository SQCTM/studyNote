# HTTP的重定向和跳转

[TOC]

## 跳转

超文本中含有超链接，可以从一个超文本跳转到另一个超文本

- **主动跳转过程**

  点击一个链接，浏览器首先会解析链接文字里的URI，再用这个URI发起一个新的HTTP请求，获取响应报文后就会切换显示内容，渲染出新URI指向的页面

- **被动跳转**

  由服务器发起的，浏览器使用者无法控制，即HTTP协议中的**重定向**



## 重定向的过程

一次重定向发送了两次HTTP请求，第一次请求返回重定向状态码，然后第二次请求就被重定向到其它指定路径

1. 第一次请求后，服务器返回的响应报文中多了一个**Location**字段，配合301/302状态码，**标记了服务器要求重定向的URI**
2. 浏览器收到301/302报文后会检查响应头里有没有Location，如果有就从该字段值里提出URI，发出新的HTTP请求

*Location里的URI既可以使用绝对URI也可以使用相对URI，相对URI即省略scheme和host:port只有path和query部分，站内跳转可以使用相对URI，如果要跳转到站外就必须用绝对URI



## 重定向状态码

- **301**

  永久重定向，即原URI已经“永久”性地不存在了，今后的所有请求都必须改用新的URI

  浏览器看到301就知道原来的URI“过时”了，就会做适当的优化。比如历史记录、更新书签，下次可能就会直接用新的URI访问，省去了再次跳转的成本；搜索引擎的爬虫看到301，也会更新索引库，不再使用老的URI

- **302**

  临时重定向，即原URI处于“临时维护”状态，新的URI是起“顶包”作用的“临时工”

  浏览器或者爬虫看到302，会认为原来的URI仍然有效，但暂时不可用，所以只会执行简单的跳转页面，不记录新的URI，也不会有其他的多余动作，下次访问还是用原URI

301和302是最常用的，除此之外还有其他几种：

- **303**

  类似302，但要求重定向后的请求改为GET方法，访问一个结果页面，避免 POST/PUT重复操作

- **307**

  类似302，但重定向后请求里的方法和实体不允许变动，含义比302更明确

- **308**

  类似307，不允许重定向后的请求变动，但它是301“永久重定向”的含义

*这三个状态码的接受程度较低，有的浏览器和服务器可能不支持



## 重定向的应用场景

- **资源不可用**

  资源不可用的原因很多，例如域名变更、服务器变更、网站改版、系统维护等，为避免出现404，就需要重定向跳转到新的URI

- **避免重复**

  让多个网址都跳转到一个URI，增加访问入口的同时还不会增加额外的工作量

- **永久和临时**

  - **301是永久的**

    如果域名、服务器、网站架构发生了大幅度的改变，比如启用了新域名、服务器切换到了新机房、网站目录层次重构等，原来的 URI 已经不能用了，必须用 301“永久重定向”，通知浏览器和搜索引擎更新到新地址，这也是搜索引擎优化（SEO）要考虑的因素之一

  - **302是临时的**

    - 原来的 URI 在将来的某个时间点还会恢复正常，常见的应用场景就是系统维护，把网站重定向到一个通知页面，告诉用户过一会儿再来访问

    - 另一种用法就是“服务降级”，比如在双十一促销的时候，把订单查询、领积分等不重要的功能入口暂时关闭，保证核心服务能够正常运行



## 重定向的相关问题

- **性能损耗**

  重定向的机制决定了一个跳转会有两次请求 - 应答，比正常的访问多了一次。大量的跳转对服务器的影响是不可忽视的。站内重定向还好，可以长连接复用，站外重定向就要开两个连接，如果网络连接质量差，成本会非常高，会严重影响用户的体验。所以重定向应当适度使用，**决不能滥用**

- **循环跳转**

  如果重定向的策略设置欠考虑，可能会出现“A=>B=>C=>A”的无限循环，不停地在这个链路里转圈圈。所以 HTTP 协议特别规定，**浏览器必须具有检测“循环跳转”的能力**，在发现这种情况时应当**停止发送请求并给出错误提示**