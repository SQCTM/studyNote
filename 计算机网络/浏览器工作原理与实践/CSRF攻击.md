# CSRF攻击

[TOC]

## CSRF攻击

CSRF全称Cross-site request forgery，即**跨站请求伪造**，是指**黑客引诱用户打开黑客的网站，在黑客的网站中利用用户的登录状态发起的跨站请求**，即CSRF攻击就是黑客利用了用户的登录状态并通过第三方的站点来做一些坏事

- **三种攻击方法**
  
  - **自动发起GET请求**
  
    比如黑客将GET请求隐藏在img标签内，欺骗浏览器这是一张图片资源，当该页面被加载时浏览器会自动发起img的资源请求，如果服务器没有对该请求做出判断，则服务器就会处理该请求
  
  - **自动发起POST请求**
  
    黑客需要在他的站点上伪造POST请求，当用户打开该站点，POST请求被自动提交
  
  - **引诱用户点击链接**
  
  *CSRF攻击不需要将恶意代码注入用户的页面，仅仅是利用服务器的漏洞和用户的登录状态来实施攻击
  
- **发起CSRF攻击的三个必要条件**
  
  - 目标站点一定要有CSRF漏洞
  - 用户要登录过目标站点，并且在浏览器上保持有该站点的登录状态
  - 需要用户打开一个第三方站点，可以是黑客的站点，也可以是一些论坛



## 防止CSRF攻击

CSRF攻击不会往页面注入恶意脚本，因此黑客无法通过CSRF攻击来获取用户页面的数据，最关键的一点是要能找到服务器的漏洞，所以对于这种攻击我们**主要的防护手段是提升服务器的安全性**

- **充分利用好Cookie的SameSite属性**

  Cookie是浏览器和服务器之间维护登录状态的一个关键数据，要防止CSRF攻击最好能实现从第三方站点发送请求时禁止Cookie的发送，因此在浏览器通过不同来源发送HTTP请求时，有如下区别：

  - 如果是从第三方站点发起的请求，那么需要浏览器禁止发送某些关键Cookie数据到服务器
  - 如果是同一站点发起的请求，那么就需要保证Cookie数据正常发送

  **SameSite有strict、Lax和None三个值**：

  - **strict**最为严格，浏览器完全禁止第三方Cookie
  - **Lax**相对宽松，在跨站点的情况下，从第三方站点的链接打开和从第三方站点提交GET方式的表单这两种方式都会携带Cookie；但如果在第三方站点使用POST方法，或者通过img、iframe等标签加载的URL，这些场景都不会携带Cookie
  - **None**在任何情况下都会发送Cookie数据

- **验证请求的来源站点**

  在服务器端验证请求来源的站点，CSRF攻击大多来自于第三方站点，因此服务器可以禁止来自第三方站点的请求

  - **判断请求是否来自第三方**

    HTTP请求头中的**Referer**和**Origin**属性

    - **Referer**是HTTP请求头中的一个字段，记录了该HTTP请求的来源地址，但有些场景不适合将来源URL暴露给服务器，因此浏览器提供给开发者一个选项，可以不用上传Referer值，具体可参考Referer Policy
    - 但在服务器验证请求头中的Refer并不是太可靠，因此又指定了**Origin属性**，Origin属性**只包含了域名信息**，并没有包含具体的URL路径，这是Origin和Referer的一个主要区别，站点为安全考虑，不想把源站点的详细路径暴露给服务器

    *服务器的策略是优先判断Origin，如果请求头中没有包含Origin属性，再根据实际情况判断是否使用Referer值

- **CSRF Token**

  - 在浏览器向服务器发起请求时，服务器生成一个CSRF Token，即服务器生成的字符串，然后将该字符串植入到返回的页面中
  - 在浏览器端如果要发起请求则需要带上页面中的CSRF Token，然后服务器会验证该Token是否合法，如果是从第三方站点发出的请求则将无法获取到CSRF Token的值，所以即使发出了请求服务器也会因为CSRF Token不正确而拒绝请求