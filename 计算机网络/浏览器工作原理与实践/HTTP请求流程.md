# HTTP请求流程

[TOC]

## HTTP协议

HTTP协议建立在TCP连接之上。HTTP是一种允许浏览器向服务器获取资源的协议，是Web的基础，也是浏览器使用最广的协议



## HTTP和TCP关系

浏览器使用HTTP协议作为应用层协议用来封装请求的文本信息，使用TCP/IP作为传输层协议将它发到网络上。HTTP的内容是通过TCP的传输数据阶段来实现的

![image-20200920203153824](C:\Users\aa\AppData\Roaming\Typora\typora-user-images\image-20200920203153824.png)



## HTTP请求过程

### 浏览器端发起HTTP请求流程

1. **构建请求**

   浏览器构建如下**请求行**信息，构建好后浏览器准备发起网络请求

   `GET /index.html HTTP1.1`

2. **查找缓存**

   真正发起网络请求前，浏览器会先在**浏览器缓存**中查询是否有要请求的文件：

   - 请求的资源已在浏览器缓存中有副本，浏览器拦截请求返回该资源的副本并直接结束请求

     这样的优点是：

     - 缓解服务器压力，提升性能（获取资源耗时更短）
     - 对于网站来说，缓存是实现快速资源加载的重要组成部分

   - 缓存查找失败，进入网络请求过程

   *浏览器缓存是一种在本地保存资源副本以供下次请求时直接使用的技术

3. **准备IP地址和端口**

   - **准备IP地址**

     浏览器在和服务器建立TCP连接时会请求**DNS**返回请求的域名对应的IP地址。浏览器还提供了**DNS数据缓存服务**，如果某个域名已经解析过浏览器会缓存解析的结果，以供下次查询时直接使用

     *DNS即域名系统，负责把域名和IP地址做一一映射关系

   - **准备端口号**

     通常情况下如果URL没有特别指明端口号，HTTP协议默认是80端口

4. **等待TCP队列**

   Chrome有个机制，同一个域名同时最多只能建立6个TCP连接，其它请求会进入排队等待状态，直至进行中的请求完成

5. **建立TCP连接**

   排队等待结束后，和服务器通过“三次握手”建立连接

6. **发送HTTP请求**

   建立了TCP连接，浏览器就可以和服务器进行通信。HTTP中的数据正是在这个通信过程中传输的

   - **HTTP请求数据格式**

     1. **请求行**

        包括请求方法（GET和POST等）、请求URI和HTTP版本协议。向服务器说明浏览器需要什么资源

     2. **请求头**

        包含一些基础信息。包括浏览器所使用的操作系统、浏览器内核等，以及当前请求的域名信息、浏览器端的Cookie信息等

     3. **请求体**

        向服务器发送的数据



### 服务器处理HTTP请求流程

1. **返回请求**

   - **服务器响应的数据格式**

     1. **响应行**

        包括HTTP协议版本和状态码

        `HTTP/1.1 200 OK`

     2. **响应头**

        包含了服务器自身的一些信息，比如服务器生成返回数据的时间、返回的数据类型以及服务器要在客户端保存的Cookie等信息

     3. **响应体**

        要发送给浏览器的数据

2. **断开连接**

   通常情况下一旦服务器向客户端返回了请求数据，它就要关闭TCP连接

   *若浏览器或服务器在其头信息中加入了：`Connection:Keep-Alive`，那么在发送后**TCP连接将仍然保持打开状态**，这样浏览器就可以继续通过同一个TCP连接发送请求。**保持TCP连接可以省去下次请求时需要建立连接的时间，提升资源加载速度**

   

## 重定向操作

当你在浏览器中打开baidu.com时，最终打开的页面地址是https://www.baidu.com/ ，这涉及到一个**重定向操作**

当请求baidu.com时，返回的响应行为：`HTTP/1.1 301 Moved Permanently`，响应头中包含的location字段为：`Location:https://www.baidu.com/`

301状态码就是告诉浏览器需要重定向到响应头Location字段中包含的网址，接下来浏览器就获取该字段地址并重新导航

*这种跳转不是必然的



## 问题解答

- **为什么很多站点第二次打开速度会很快？**

  因为第一次加载页面过程中，浏览器将**页面资源**缓存在了本地，之后浏览器缓存直接使用本地副本来回应请求，不产生真实的网络请求，从而节省了时间。**DNS**也被浏览器缓存，省去了DNS查询环节

  - **缓存流程**
    - 第一次加载页面，缓存为空，继续请求服务器，然后服务器返回HTTP响应头给浏览器时，浏览器通过响应头中的**Cache-Control**字段来设置是否缓存该资源，还通过Cache-Control中的Max-age参数来为这个资源设置一个**缓存过期时长**
    - 缓存资源未过期时加载页面缓存会直接返回资源给浏览器
    - 若缓存资源过期了加载页面浏览器则会继续发起网络请求，并在HTTP请求头中带上**If-None-Match**字段，服务器会根据该字段的值来判断**请求的资源是否有更新**：
      - 若没有更新，就返回304，表示继续使用该缓存
      - 若更新了，服务器就直接返回最新资源给浏览器

- **登录状态如何保存？**

  1. 浏览器将用户登录信息通过POST方法提交给服务器
  2. 服务器收到后验证信息是否正确，若正确则会生成一段表示用户身份的字符串并将其写到响应头的Set-Cookie字段中，再将响应头发送给浏览器
  3. 浏览器收到后开始解析响应头，并将Set-Cookie字段保存到本地
  4. 用户再次访问时，浏览器读取之前保存的Cookie数据并写入请求头的Cookie字段中，再发送请求头
  5. 服务器收到后根据Cookie字段判断该用户是已登录状态，然后将该用户信息数据发送给浏览器