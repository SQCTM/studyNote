# XMLHttpRequest

[TOC]

XMLHttpRequest提供了从Web服务器获取数据的能力，若想更新某条数据，只需通过XMLHttpRequest请求服务器提供的接口就可以获取到数据，然后再操作DOM来更新页面内容，只需要更新网页的一部分而不用刷新整个页面，既有效率又不会打扰到用户



## 回调函数与系统调用栈

- **回调函数**

  将一个函数作为参数传递给另一个函数，作为参数的函数就是回调函数

  - **同步回调**

    回调函数在主函数返回前执行

  - **异步回调**

    回调函数在主函数外部执行，如使用setTimeout函数延迟回调函数的执行

  - 同步回调函数在主函数的上下文中执行回调函数，而异步回调函数在主函数外执行，执行方式有两种：

    - 把异步函数当做一个任务添加到信息队列尾部
    - 把异步函数添加到微任务队列中，在当前任务的末尾处执行微任务

- **系统调用栈**

  当循环系统在执行一个任务时都会为这个任务维护一个系统调用栈



## XMLHttpRequest运作机制

1. **创建XMLHttpRequest对象**

   `let xhr = new XMLHttpRequest();`

2. **为xhr对象注册回调函数**

   网络请求比较耗时，所以要注册回调函数，后台任务执行完成后就会通过调用回调函数来告诉其执行结果

   | 回调函数种类名称   | 作用                                                         |
   | :----------------- | ------------------------------------------------------------ |
   | ontimeout          | 用来监控超时请求，如果后台请求超时，该函数会被调用           |
   | onerror            | 用来监控出错信息，如果后台请求出错，该函数会被调用           |
   | onreadystatechange | 监控后台请求过程中的状态，可以监控到HTTP加载完成的消息、HTTP响应体消息以及数据加载完成的消息等 |

3. **配置基础的请求信息**

   - 通过**open接口**配置一些基础信息，包括请求地址、请求方法（GET或POST）和请求方式（同步或异步）
   - 通过xhr内部属性类配置一些其他可选的请求信息

4. **发起请求**

   调用`xhr.send()`来发起网络请求。渲染进程将请求发送给网络进程，网络进程负责资源的下载，等网络进程接收到数据后就会利用IPC来通知渲染进程，渲染进程接收到消息后会将xhr的回调函数封装成任务并添加到消息队列中，等主线程循环系统执行到该任务时就会根据相关的状态来调用对应的回调函数



## 容易遇到的问题

- **跨域问题**

  默认情况下，跨域请求是不被允许的

- **混合内容问题**

  HTTPS混合内容是HTTPS页面中包含了不符合HTTPS安全要求的内容，如果HTTPS请求页面中使用混合内容浏览器会针对混合内容显示警告，虽然会给出警告但大部分类型还是能加载的；但若用XMLHttpRequest请求时浏览器认为这种请求可能是攻击者发起的，会阻止此类危险的请求



