# 优化页面性能

[TOC]

页面优化即让页面更快地显示和响应



## 页面生成周期阶段

有三个阶段：

1. **加载阶段**

   指从发出请求到渲染出完整页面的过程，影响到这个阶段的主要因素有网络和JS脚本

2. **交互阶段**

   从页面加载完成到用户交互的整合过程，影响这个阶段的主要因素是JS脚本

3. **关闭阶段**

   用户发出关闭指令后页面所做的一些清理操作



## 影响页面性能因素和优化方案

能阻塞网页首次渲染的资源被称为关键资源，主要有JS文件、首次请求的HTML资源文件和CSS文件



### 加载阶段

- **因素**

  - **关键资源个数**：个数越多首次页面的加载时间越长
  - **关键资源大小**：内容越小下载时间越短，阻塞渲染的时间越短
  - **请求关键资源需要多少个RTT**：RRT表示从发送端发送数据开始到发送端收到来自接收端的确认总共经历的时延，即往返时延，它是网络中一个重要的性能指标

- **优化方案**

  **原则**：减少关键资源个数，降低关键资源大小，降低关键资源的RTT次数

  - **减少关键资源个数**

    - 将JS和CSS改成内联式
    - 如果JS代码没有DOM或CSSOM操作则可以改成sync或defer属性，CSSlink属性之前加上取消阻止显现标志，这样它们就变成了非关键资源

  - **减少关键资源大小**

    压缩CSS和JS资源，移除HTML、CSS、JS文件中一些注释内容，也可以通过前面讲的取消CSS或JS中关键资源的方式

  - **减少RTT次数**

    通过减少关键资源个数和大小搭配来实现，还可以使用CDN来减少RTT时长



### 交互阶段

交互阶段的优化即渲染进程渲染帧的速度，帧的渲染速度决定了交互的流畅度

- **优化方案**

  **原则**：让单个帧的生成速度变快

  - **减少JS脚本执行时间**

    - 将一次执行的函数分解为多个任务，使得每次的执行时间不要过久
    - 采用Web Workers，可以把它当作主线程外的另一个线程，在其中也可以执行JS脚本，不过它没有DOM、CSS环境，即在其中无法通过JS来访问DOM，所以可以把一些和DOM操作无关且耗时的任务放到这里面去执行

  - **避免强制同步布局**

    强制同步布局是指JS强制将计算样式和布局操作提前到当前的任务中

    *尽量不要在修改DOM结构时去查询相关值

  - **避免布局抖动**

    布局抖动是指在一次JS执行过程中多次执行强制布局和抖动操作

    *同样尽量不要在修改DOM结构时去查询相关值

  - **合理利用CSS合成动画**

    合成动画直接在合成线程上执行，这和在主线程上执行的操作不同。如果主线程被JS或者一些布局任务占用，CSS动画依然能继续执行

  - **避免频繁的垃圾回收**

    若在一些函数中频繁创建临时对象，垃圾回收器频繁执行垃圾回收策略，这样操作发生时会占用主线程，从而影响到其他任务的执行，严重的话会让用户产生掉帧、不流畅的感觉。要尽可能优化储存结构避免小颗粒对象的产生

