# 消息队列和事件循环

[TOC]

## 单线程处理安排好的任务

把所有任务代码按照顺序写进主线程，线程执行时任务会按照顺序在线程中依次被执行，等所有任务执行完成后线程会自动退出



## 事件循环机制

在线程运行过程中能接收并执行新的任务

- **引入循环**

  线程循环执行

- **引入事件**

  等待输入任务，等待过程中线程处于暂停状态，一旦接收到任务线程就会被激活，执行后输出结果

*所有任务来自于**线程内部**

![事件循环](F:\前端笔记\studyNote\images\事件循环.png)



## 消息队列

一种数据结构，可以存放要执行的任务，符合队列“**先进先出**”的特点

- **消息队列中的任务类型**

  - **内部消息类型**

    输入事件、微任务、文件读写、WebSocket、JavaScript定时器等

  - **页面相关事件**

    JavaScript执行、解析DOM、样式计算、布局计算、CSS动画等

- **缺点**

  消息队列机制不够灵活，为了适用效率和实时性，引入了微任务



## 线程模式：队列+循环

可以处理其他线程以及进程发送过来的任务，使用**消息队列**接收其他进程发送来的任务

![线程模式：队列+循环](F:\前端笔记\studyNote\images\线程模式：队列+循环跨进程发送消息.png)

- 添加一个消息队列
- IO线程中产生的新任务添加进消息队列尾部
- 渲染主线程会循环地从消息队列头部中读取、执行任务

*IO线程用来接收其他进程传进来的消息并将它们组装成任务发送给渲染主线程



## 安全退出

当页面主线程执行完成后确定要退出当前页面时，页面主线程会设置一个退出标志的变量，在每次执行完一个任务时，判断是否有设置退出标志，如果设置了则直接中断当前所有任务并退出线程



## 页面使用单线程的缺点

- **如何处理高优先级的任务**

  消息队列中的任务被称为**宏任务**，每个宏任务中都包含了一个**微任务队列**，等宏任务中的主要功能都直接完成后，渲染引擎不着急去执行下一个宏任务，而是执行当前宏任务中的微任务

- **如何解决单个任务执行时长过久**

  JavaScript通过回调功能来规避这种问题，让要执行的JavaScript任务滞后执行



