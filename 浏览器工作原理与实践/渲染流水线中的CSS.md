# 渲染流水线中的CSS

[TOC]

## 渲染流水线视角下的CSS

- **渲染流水线流程**

  - **含有CSS**

    ![含有CSS页面的渲染流水线](F:\前端笔记\studyNote\images\含有CSS页面的渲染流水线.jpg)

    1. 首先发起主页面的请求，发起请求放可能是渲染进程也可能是浏览器进程，发起的请求被送到网络进程中去执行
    2. 网络进程收到返回的HTML数据后将其发送给渲染进程，渲染进程会解析HTML数据并构建DOM
    3. DOM构建结束后向网络进程发起请求CSS文件
    4. 网络进程收到返回的CSS数据后将其发送给渲染进程，渲染进程收到后将其解析成CSSOM并构建布局树

    *请求HTML数据和构建DOM中间有一段空闲时间，可能成为页面渲染的瓶颈

  - **含有CSS+JS**（若在两个div中间插入js脚本）

    ![含有JS+CSS页面的渲染流水线](F:\前端笔记\studyNote\images\含有JS+CSS页面的渲染流水线.jpg)

    在接收到HTML数据后的预解析过程中，HTML预解析器识别出来了有CSS文件和JS文件需要下载，然后同时发起这两个文件的下载请求

    *两个文件的下载过程是重叠的，所以下载时间按照最久的文件来算

- **CSSOM**

  渲染引擎无法直接理解CSS，需要将其解析成渲染引擎能够理解的结构CSSOM。CSSOM体现在DOM中就是`document.styleSheets`

  - **作用**
    - 提供给JS操作样式表的能力
    - 为布局树的合成提供基础的样式信息

- **合成布局树**

  基本上是复制DOM树的结构，不同之处在于DOM树中不需要显示的元素会被过滤掉。复制好后渲染引擎进行**样式计算**为对应的DOM元素选择对应的样式信息，再进行**计算布局**计算布局树中每个元素对应的几何位置



## 影响页面展示的因素以及优化策略

渲染流水线影响到首次页面展示的速度，而首次页面展示的速度又直接影响到了用户体验

- **从发起URL到首次显示页面视觉上经历的三个阶段**
  1. **第一阶段**：发出请求后到提交数据，此阶段页面展示出来的还是之前页面的内容
  2. **第二阶段**：提交数据后渲染进程会创建一个空白页面，这段时间称为**解析白屏**，并等待CSS文件和JS文件的加载完成，生成CSSOM和DOM，然后合成布局树，最后还要经过一系列步骤准备首次渲染
  3. **第三阶段**：等首次渲染完成后就开始进入完整页面的生成节点，然后页面会被绘制出来
- **影响因素**
  - 影响第一个阶段的因素主要是网络或服务器
  - 第二、三个阶段的主要问题是白屏时间，通常瓶颈主要体现在下载CSS和JS文件以及执行JS
- **缩短白屏时间策略**
  - 内联JS和CSS来移除这两种文件的下载，这样获取到HTML文件后就可以直接开始渲染流程
  - 若场景不适合内联，可以尽量减小文件大小，如通过webpack等工具移除一些不必要的注释并压缩JS文件
  - 将不需要在解析HTML阶段使用的JS标记上sync或defer
  - 对于大的CSS文件可以通过媒体查询属性，将其拆分为多个不同用途的CSS文件，这样只有在特定的场景下才会加载特定的CSS文件