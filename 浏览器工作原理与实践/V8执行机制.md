# V8执行机制

[TOC]

## 编译器和解释器

- **编译型语言**

  编译型语言在程序执行前需要经过编译器的编译过程，并且编译之后会直接保留机器能读懂的二进制文件，这样每次运行程序时都可以直接运行该二进制文件，不需要再次重新编译了。（比如C/C++、GO等

- **解释型语言**

  在每次运行时都需要通过解释器对程序进行动态解释和执行。（比如Python、JavaScript等

![编译器和解释器翻译代码流程](F:\前端笔记\studyNote\images\编译器和解释器翻译代码流程.jpg)



## V8执行JavaScript代码机制

1. **生成抽象语法树(AST)和执行上下文**

   将源代码转换为抽象语法树并生成执行上下文。编译器和解释器无法理解高级语言，可以理解AST

   - **生成AST阶段**
     1. **分词**：又称为**词法分析**，将一行行源码拆解成一个个**token**。token即语法上不能再分的，最小的单个字符或字符串
     2. **解析**：又称为**语法分析**，其作用是将上一步生成的token数据根据语法规则转为AST。如果源码不符合语法规则就会终止执行并抛出一个“语法错误”

2. **生成字节码**

   解释器Ignition根据AST生成字节码并执行

   - **字节码**

     字节码是介于AST和机器码之间的一种代码，但与特定类型的机器码无关，字节码需要通过解释器将其转换为机器码后才能执行，**使用字节码可以减少系统的内存使用**

3. **执行代码**

   执行字节码的过程中如果发现有**热点代码**即一段被重复执行的代码，则后台编译器TurboFan就会把它编译为高效的机器码，然后再次执行这段被优化的代码时，只需要执行编译后的机器码，这样大大提升了代码的执行效率；如果是第一次执行的字节码，解释器就会逐条解释执行

   ***即使编译(JIT)**：解释器Ignition在解释执行字节码的同时收集代码信息，当它发现某部分代码变热后，TurboFan编译器就将热点字节码转换为机器码并保存起来，以备下次使用



## JavaScript的性能优化

- 提升单词脚本的执行速度，避免JavaScript的长任务霸占主线程，这样可以使得页面快速响应交互
- 避免大的内联脚本，因为在解析HTML的过程中解析和编译也会占用主线程
- 减少JavaScript文件的容量，因为更小的文件会提升下载速度，并占用更低的内存