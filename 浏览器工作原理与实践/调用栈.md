# 调用栈

[TOC]

调用栈是用来管理函数调用关系的一种数据结构



## 创建执行上下文的条件

- 当js执行全局代码时会编译全局代码并创建**全局执行上下文**。在整个页面生存周期内，全局执行上下文只有一份
- 调用一个函数时，函数体内的代码被编译并创建**函数执行上下文**；函数执行结束，函数执行上下文被销毁
- 使用**eval函数**时，eval的代码被编译并为其创建执行上下文



## 函数调用

1. js引擎编译全局代码并创建**全局执行上下文**，代码中的**全局变量**和**函数**都保存在全局上下文的变量环境中
2. 执行上下文准备好后开始执行全局代码，当执行到一个函数调用时：
   1. 从全局执行上下文中取出该函数
   2. 对该函数的代码进行编译，并**创建该函数的执行上下文和可执行代码**
   3. 执行代码，输出结果
   4. 执行完毕，销毁函数执行上下文



## JavaScript的调用栈

js引擎利用调用栈（执行上下文栈）来**管理执行上下文**，追踪函数执行

- **调用栈工作过程例子**

  ```javascript
  var a = 2;
  function add(b, c) {
      return b+c;
  }
  function addAll(b, c) {
      var d = 10;
      result = add(b, c)
      return a+result+d
  }
  addAll(3, 6);
  ```

  1. 创建全局上下文并将其压入栈底
  2. 执行全局代码，执行到调用addAll函数，js引擎编译该函数，为其创建一个执行上下文并压入栈中，再执行函数中的代码
  3. 执行到调用add函数，js引擎编译该函数，为其创建一个执行上下文并压入栈中，再执行函数中的代码
  4. add函数执行完毕，该函数执行上下文从栈顶弹出
  5. addAll函数执行完毕，执行上下文从栈顶弹出
  6. 全局上下文留在栈中



## 使用调用栈的好方法

- **查看调用栈的信息**

  - 在浏览器控制台Sources中可以给代码加断点，执行代码时执行流程会在断点处暂停，然后可以在Call Stack查看调用栈情况
  - 在代码中加上`console.trace()`来输出当前函数调用关系

- **栈溢出**

  调用栈有大小，当入栈的执行上下文超过一定数目就会报错，写递归代码时易发生栈溢出错误

