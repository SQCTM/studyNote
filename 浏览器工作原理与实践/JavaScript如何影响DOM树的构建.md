# JavaScript如何影响DOM树的构建

[TOC]

## 什么是DOM

从网络传给渲染引擎的HTML文件字节流无法被渲染引擎直接理解，所以要将其转化为渲染引擎能够理

解的内部结构即DOM。**DOM提供了对HTML文档结构化的表述**

- **DOM在渲染引擎中的作用**
  - 从页面的视角来看，DOM是生成页面的基础数据结构
  - 从JS脚本视角来看，DOM提供给JS脚本操作的接口，通过这套接口JS可以对DOM进行访问，从而改变文档的结构、样式和内容
  - 从安全视角来看，DOM是一道安全防护线，一些不安全的内容在DOM解析阶段就被拒之门外

***DOM是表述HTML的内部数据结构，它将Web页面和JavaScript脚本连接起来，并过滤一些不安**

**全的内容**



## DOM树如何生成

- **HTML解析器**

  将HTML字节流转换为DOM结构，**网络进程加载多少数据HTML解析器便解析多少数据**

  - **解析流程**
    1. 网络进程接收到响应头后根据请求头中的content-type字段来判断文件的类型，若是HTML类型文件就会为该请求选择或创建一个渲染进程
    2. 渲染进程准备好后，网络进程和渲染进程之间会建立一个**共享数据的管道**，网络进程将接收到的数据放里面放，而渲染进程则从中读取数据，渲染进程中的HTML解析器就会动态接收字节流并将其解析为DOM

- **DOM的生成**

  - **通过分词器将字节流转换为Token**

    分词器将字节流转换为一个个Token，分为TagToken和文本Token，其中TagToken又分为StartTag和EndTag

  - **将Token解析为DOM节点并添加到DOM树中**

    HTML解析器维护了一个**Token栈结构**，用来计算节点之间的父子关系，第一个阶段中生成的Token会按照顺序被压入栈中，具体**处理规则**：

    - 若压入地栈中的是**StartTag Token**，HTML解析器会为该Token创建一个**DOM节点**并加入到DOM树中，它的父节点是栈中相邻的那个元素生成的节点
    - 若分词器解析出来的是**文本Token**，则会生成一个**文本节点**并加入到DOM树中，**文本Token不压入栈中**，它的父节点是当前栈顶Token所对应地DOM节点
    - 如果分词解析出来的是**EndTag标签**，HTML解析器会查看Token栈顶的元素是否是相应的StartTag ，如果是就将StartTag从栈顶弹出来表示该元素解析完成，如果不是则应该是出现了错误应该有容错机制

    *HTML解析器开始工作时，会默认创建了一个根为document的空DOM结构，同时会将一个StartTag document的Token压入栈底



## JavaScript影响DOM树的生成

- **影响**

  - **在两个div之间插入JS脚本**

    在script标签之前HTML正常工作，遇到script内嵌脚本HTML解析器暂停工作，JS引擎介入执行script标签中的这段脚本，执行完成后HTML解析器恢复解析继续后续内容，直至生成最终DOM

  - **在两个div之间引入JS文件**

    执行流程与前者相似，但**JS文件的下载过程会阻塞DOM解析**，通常下载非常耗时，受到网络环境、JS文件大小等因素的影响

    - **优化：预解析操作**

      Chrome让渲染引擎收到字节流后会开启一个预解析线程，用来分析HTML文件中包含的JS、CSS等相关文件，解析到相关文件后预解析线程会提前下载这些文件

- **规避JS影响**

  - 使用CDN来加速JS文件的加载
  - 压缩JS文件的体积
  - 如果JS文件中没有操作DOM相关代码可以将该脚本设置为异步加载

- **CSSOM**

  在执行JavaScript之前需要先解析JS语句上所有的CSS样式。所以如果代码里引用了外部的CSS文件，那么在执行JS之前还需要等待外部的CSS文件下载完成，并解析生成CSSOM对象之后，才能执行JavaScript脚本

  JS引擎在解析JS之前不知道JS是否操纵了CSSOM，所以渲染引擎在遇到JS脚本时不管该脚本是否操纵了CSSOM都会执行CSS文件下载，解析操作，再执行JS脚本

  所以JS脚本是依赖样式表的，这又多了一个阻塞过程