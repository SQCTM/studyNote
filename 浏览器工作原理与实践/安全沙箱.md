# 安全沙箱

[TOC]

## 单进程架构的浏览器

从稳定性视角来看，单进程架构的浏览器是不稳定的，会影响到操作系统的安全

- **缓冲区溢出**

  浏览器本身的漏洞是单进程浏览器的一个主要问题，如果浏览器被曝出存在漏洞，则在漏洞没有被及时修复的情况下，黑客就有可能通过恶意页面向浏览器中注入恶意程序，其中最常见的攻击方式是利用**缓冲区溢出**

  *这种类型的攻击和XSS注入的脚本不一样

  - XSS攻击只是将恶意的JS脚本注入到页面中，虽然能窃取一些Cookie相关的数据，但是XSS无法对操作系统进行攻击
  - 而通过浏览器漏洞进行的攻击是**可以入侵到浏览器进程内部**的，可以读取和修改浏览器进程内部任意内容，还**可以穿透浏览器到用户的操作系统上**悄悄地安装恶意软件、监听用户键盘输入信息以及读取用户硬盘上的文件内容

  *这样将整个操作系统的内容都暴露给黑客，操作系统上所有的资料都是不安全的了



## 安全视角下的多进程架构

现代浏览器的设计目标是**安全**、**快速**和**稳定**，浏览器主要被划分为**浏览器内核**和**渲染内核**：

- **浏览器内核**：网络进程、浏览器主进程和GPU进程组成

- **渲染内核**：渲染进程

- **两者配合**

  所有的网络资源都是通过浏览器内核来下载的，下载后的资源会通过IPC将其提交给渲染进程（浏览器内核和渲染进程之间都是通过IPC来通信的），然后渲染进程会对这些资源进行解析、绘制等操作，最终生成一幅图片。但是渲染进程并不负责将图片显示到界面上，而是将最终生成的图片提交给浏览器内核模块，由浏览器内核模块负责显示这张图片



## 安全沙箱

由于渲染进程需要执行解析DOM、解析CSS、网络图片编码等操作，如果渲染进程中存在系统级别的漏洞，那么以上操作都有可能让恶意站点获取到渲染进程的控制权限，进而又获得操作系统的控制权限，这对于用户是非常危险的

因为网络资源的内容存在各种个能性，所以**浏览器会默认所有的网络资源都是不可信的**，都是不安全的。但不能保证浏览器不存在漏洞，只要出现漏洞，黑客就可以通过网络内容对用户发起攻击。

如果下载了一个恶意程序但没有执行它，恶意程序就不会生效，浏览器之于网络也是如此。浏览器可以安全下载各种网络资源，但是如果要执行这些资源，比如解析HTML、解析CSS、执行JavaScript，图片编码等操作，就需要非常谨慎，防止黑客就会利用这些操作对含有漏洞的浏览器发起攻击

**将渲染进程和操作系统隔离的墙即安全沙箱**

- **渲染进程和浏览器内核的功能**
  
  - **渲染进程**
  
    HTML解析、CSS解析、图片解码、JS执行、布局、绘制、XML解析
  
  - **浏览器内核**
  
    Cookie存储、Cache存储、网络请求、文件读取、下载管理、SSL/TSL、浏览器窗口管理
  
- **对各个模块功能的影响**

  安全沙箱最小的保护单位是进程，并且能限制进程对操作系统资源的访问和修改，因此如果要让安全沙箱应用在某个进程上，那么这个进程**必须没有读写操作系统的功能**

  - **持久存储**

    安全沙箱需要负责确保渲染进程无法直接访问用户的文件系统，但在渲染进程内部有访问Cookie等的需求，为了解决这些需求，现代浏览器将读写文件的操作全部放在了浏览器内核中实现，然后通过IPC将操作结果转发给渲染进程

    - **如下文件内容的读写都是在浏览器内核中完成**

      - **存储Cookie数据的读写**

        通常浏览器内核会维护一个存放所有Cookie的Cookie数据库，然后当渲染进程通过JS来读取Cookie时，渲染进程会通过IPC将读取Cookie的信息发送给浏览器内核，浏览器内核读取Cookie后再将内容返回给渲染进程

      - **缓存文件的读写**

        比如网络文件缓存的读取

  - **网络访问**

    有了安全沙箱渲染进程内部不能直接访问网络，如果要访问则需要通过浏览器内核。浏览器内核在处理URL请求之前会检查渲染进程是否有权限请求该URL，比如检查XMLHttpRequest或者Fetch是否是跨站点请求，或检测HTTPS的站点中是否包含了HTTP的请求

  - **用户交互**

    渲染进程**不能直接访问窗口句柄，也限制了渲染进程监控到用户的输入事件**，所以渲染进程需要完成一下两点大的改变：

    - **渲染进程需要渲染出位图**

      为了向用户显示渲染进程渲染出的位图，渲染进程需要将生成好的位图发送给浏览器内核，然后浏览器内核上将位图复制到屏幕上

    - **操作系统没有将用户输入事件直接传给渲染进程而是传给浏览器内核**

      然后浏览器内核再根据当前浏览器界面的状态来判断如何调度这些事件，如果当前焦点位于浏览器地址栏中，则输入事件会在浏览器内核内部处理；如果当前焦点在页面的区域内，则浏览器内核会将输入事件转发给渲染进程

    *这是为了限制渲染进程监控到用户输入事件的能力，所以所有的键盘鼠标事件都是由浏览器内核来接收，然后再通过IPC将这些事件发送给渲染进程



## 站点隔离

站点隔离是指Chrome将同一站点（包含相同根域名和相同协议的地址）中相互关联的页面放到同一渲染进程中执行

- **作用**

  实现了站点隔离，就可以将恶意的iframe隔离在恶意进程内部，使得它无法继续访问其它iframe进程的内容，因此也就无法攻击其他站点